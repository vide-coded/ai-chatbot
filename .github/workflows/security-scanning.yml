### 5. Security Scanning Workflow

### File: .github/workflows/security-scanning.yml

name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 0 * * *' # Run daily at midnight

jobs:
  dependency-scanning:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        
      - name: Install dependencies
        run: bun install
        
      - name: Run Snyk security scan
        uses: snyk/actions/node@v1
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
          
      - name: Run npm audit
        run: bun run npm audit --audit-level=high
        
      - name: Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: security-report.json

  code-scanning:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript-typescript
          
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:javascript-typescript"

  secret-scanning:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
          GITLEAKS_CONFIG: .gitleaks.toml
        
      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog-action@v1
        with:
          path: .
          base: ${{ github.base_ref }}
          head: ${{ github.head_ref }}

  vulnerability-notification:
    needs: [dependency-scanning, code-scanning, secret-scanning]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check for vulnerabilities
        id: check-vulnerabilities
        run: |
          # Check if any security scans failed
          if [ "${{ needs.dependency-scanning.result }}" = "failure" ] || 
             [ "${{ needs.code-scanning.result }}" = "failure" ] || 
             [ "${{ needs.secret-scanning.result }}" = "failure" ]; then
            echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT
          else
            echo "vulnerabilities_found=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Create security alert
        if: steps.check-vulnerabilities.outputs.vulnerabilities_found == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const securityAlert = `ğŸš¨ **Security Alert: Vulnerabilities Detected**

ğŸ”´ **Critical Issues Found**

Please review the security scan results:

- **Dependency Scanning**: ${{ needs.dependency-scanning.result }}
- **Code Scanning**: ${{ needs.code-scanning.result }}
- **Secret Scanning**: ${{ needs.secret-scanning.result }}

ğŸ“‹ **Next Steps**:
1. Review security scan reports
2. Update vulnerable dependencies
3. Fix code vulnerabilities
4. Remove exposed secrets
5. Request re-scan

âš ï¸ **Do not merge until vulnerabilities are resolved!**`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: securityAlert
            });
            
            // Add security alert label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['security-alert', 'vulnerability']
            });

  security-dashboard:
    needs: [dependency-scanning, code-scanning, secret-scanning]
    runs-on: ubuntu-latest
    steps:
      - name: Download security reports
        uses: actions/download-artifact@v3
        with:
          path: security-reports
          
      - name: Generate security dashboard
        run: |
          # Generate security dashboard from reports
          node scripts/generate-security-dashboard.js
          
      - name: Update security dashboard
        run: |
          git config --global user.name "Security Bot"
          git config --global user.email "security@bot.com"
          git add security-dashboard.md
          git commit -m "chore: update security dashboard"
          git push

  notify-security-team:
    needs: vulnerability-notification
    if: steps.check-vulnerabilities.outputs.vulnerabilities_found == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Send security alert to Slack
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SECURITY_SLACK_WEBHOOK }}
          SLACK_COLOR: danger
          SLACK_TITLE: "ğŸš¨ Security Alert: Vulnerabilities Detected"
          SLACK_MESSAGE: "Critical security vulnerabilities found in ${{ github.repository }}. Please review immediately!"
          SLACK_FOOTER: "Security Dashboard | Do not merge until resolved"
          
      - name: Send security alert email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸš¨ Security Alert: Vulnerabilities in ${{ github.repository }}"
          body: "Critical security vulnerabilities detected. Please review the security dashboard and resolve issues before merging."
          to: security-team@example.com
          from: security-bot@example.com

# Example Gitleaks configuration
# File: .gitleaks.toml
[allowlist]
  description = "Global Allowlist"
  paths = [
    "**/test/**",
    "**/examples/**"
  ]

[[rules]]
  description = "AWS Access Key"
  id = "aws-access-key"
  regex = '''aws(.{0,20})?['\"][0-9a-zA-Z/+]{40}['\"]'''
  tags = ["key", "AWS"]

[[rules]]
  description = "GitHub Token"
  id = "github-token"
  regex = '''ghp_[0-9a-zA-Z]{36}'''
  tags = ["key", "GitHub"]

[[rules]]
  description = "Private Key"
  id = "private-key"
  regex = '''-----BEGIN (RSA|DSA|EC|OPENSSH|PGP) PRIVATE KEY( BLOCK)?-----'''
  tags = ["key", "private"]

# Example security dashboard template
# File: security-dashboard.md
# Security Dashboard

## ğŸ›¡ï¸ Current Security Status

**Last Updated**: 2025-01-15
**Overall Risk Level**: ğŸŸ¢ Low

## ğŸ“Š Security Metrics

### Dependency Security
- **Vulnerabilities**: 0 Critical, 2 Medium, 5 Low
- **Risk Level**: ğŸŸ¢ Low
- **Last Scan**: 2025-01-15 14:30 UTC

### Code Quality
- **CodeQL Alerts**: 0 Critical, 1 Medium, 3 Low
- **Risk Level**: ğŸŸ¢ Low
- **Last Scan**: 2025-01-15 14:35 UTC

### Secret Detection
- **Exposed Secrets**: 0
- **Risk Level**: ğŸŸ¢ None
- **Last Scan**: 2025-01-15 14:40 UTC

## ğŸš¨ Open Security Issues

### Critical Issues (0)
- None

### Medium Issues (3)
1. **Dependency**: `lodash@4.17.21` - Prototype Pollution (CVE-2021-23337)
   - **Risk**: Medium
   - **Fix**: Update to lodash@4.17.22
   - **Status**: Open
   
2. **CodeQL**: Hardcoded Password in test file
   - **Risk**: Medium
   - **Fix**: Remove hardcoded credentials
   - **Status**: Open

### Low Issues (8)
1. **Dependency**: `moment@2.29.4` - Deprecated package
2. **CodeQL**: Unused variable in utils.ts
3. **Gitleaks**: Potential API key in example file

## âœ… Resolved Issues (Last 30 Days)

1. **Critical**: SQL Injection vulnerability in user query
   - **Fixed**: 2025-01-10
   - **Resolution**: Added parameterized queries
   
2. **High**: Exposed AWS access key in config
   - **Fixed**: 2025-01-12
   - **Resolution**: Moved to secrets management

## ğŸ“‹ Security Compliance

- **OWASP Top 10**: 95% compliant
- **CIS Benchmarks**: 88% compliant
- **GDPR**: 100% compliant
- **PCI DSS**: N/A (not handling payments directly)

## ğŸ› ï¸ Security Best Practices

### âœ… Implemented
- [x] Dependency scanning in CI/CD
- [x] Code quality analysis
- [x] Secret detection
- [x] Regular security audits
- [x] Security headers
- [x] Input validation
- [x] Rate limiting

### âš ï¸ Partially Implemented
- [ ] Automated dependency updates
- [ ] Security training for developers
- [ ] Regular penetration testing

### âŒ Not Implemented
- [ ] Automated security patching
- [ ] Real-time threat detection
- [ ] Security champion program

## ğŸ¯ Security Roadmap

### Q1 2025
- [ ] Implement automated dependency updates
- [ ] Add real-time threat detection
- [ ] Conduct penetration testing

### Q2 2025
- [ ] Implement security champion program
- [ ] Add security training for developers
- [ ] Improve secret management

## ğŸ“ˆ Security Trends

```
ğŸ“ˆ Vulnerabilities Over Time
Jan: 12 â†’ Feb: 8 â†’ Mar: 5 â†’ Apr: 3

ğŸ“‰ Mean Time to Resolution
Jan: 7 days â†’ Feb: 5 days â†’ Mar: 3 days â†’ Apr: 2 days

ğŸ“Š Compliance Score
Jan: 85% â†’ Feb: 88% â†’ Mar: 92% â†’ Apr: 95%
```

## ğŸ”— Security Resources

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [CIS Benchmarks](https://www.cisecurity.org/cis-benchmarks/)
- [Snyk Vulnerability DB](https://snyk.io/vuln)
- [GitHub Security Lab](https://securitylab.github.com/)

---

**Security is everyone's responsibility. Stay vigilant! ğŸ›¡ï¸**